# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

set -g @plugin 'tmux-plugins/tmux-sessionist'
set -g @plugin 'tmux-plugins/tmux-resurrect'

# Other examples:
# set -g @plugin 'github_username/plugin_name'
# set -g @plugin 'github_username/plugin_name#branch'
# set -g @plugin 'git@github.com:user/plugin'
# set -g @plugin 'git@bitbucket.com:user/plugin'


set -g default-terminal "xterm-kitty"                                                                    
set -g terminal-overrides "xterm-kitty"

# Remap prefix from 'C-b' to 'C-a'
unbind C-b
set-option -g prefix C-a
bind-key C-a send-prefix

# Split panes using | and - in current path
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# set extended keys for nvim repeatable command
set -s extended-keys on
set -as terminal-features 'xterm*:extkeys'

# setup vim-tmux navigator
# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
# Note: we did this manually so that we could set the -Z flag
vim_pattern='(\S+/)?g?\.?(view|l?n?vim?x?|fzf)(diff)?(-wrapped)?'
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +${vim_pattern}$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L -Z'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D -Z'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U -Z'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R -Z'
tmux_version='$(tmux -V | sed -En "s/^tmux ([0-9]+(.[0-9]+)?).*/\1/p")'
if-shell -b '[ "$(echo "$tmux_version < 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\'  'select-pane -l -Z'"
if-shell -b '[ "$(echo "$tmux_version >= 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\\\'  'select-pane -l -Z'"

bind-key -T copy-mode-vi 'C-h' select-pane -L -Z
bind-key -T copy-mode-vi 'C-j' select-pane -D -Z
bind-key -T copy-mode-vi 'C-k' select-pane -U -Z
bind-key -T copy-mode-vi 'C-l' select-pane -R -Z
bind-key -T copy-mode-vi 'C-\' select-pane -l -Z

# Bind a key to open scrollback in $EDITOR (pipe copy mode to neovim)
bind-key v run-shell 'tmux capture-pane -peS -32768 > /tmp/tmux-buffer.out && tmux new-window "nvim +$ /tmp/tmux-buffer.out"'

# set thicker tmux pane line for visibility
set -g pane-border-lines heavy
# set-option -g pane-border-style 'fg=#596763' #match everforest dark

# set vi keybindings for copy mode
setw -g mode-keys vi

# copy tmux buffer to clipboard
set -s set-clipboard on
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# set -ga terminal-overrides ",*256col*:Tc"                                                                              
set -ga terminal-overrides ",xterm-256color:Tc"                                                                         
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'                                                   
# underscore colours - needs tmux-3.0                                                                                               
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'
# trying to get clipboard passthrough to work
set -s set-clipboard on
set -as terminal-features ',xterm-kitty:clipboard'

# tmux everforest theme
  # COLORSCHEME: everforest dark medium
  set -g @everforest_bg_dim '#1e2326'
  set -g @everforest_bg0 '#2d353b'
  set -g @everforest_bg1 '#343f44'
  set -g @everforest_bg2 '#3d484d'
  set -g @everforest_bg3 '#475258'
  set -g @everforest_bg4 '#4f585e'
  set -g @everforest_bg5 '#56635f'
  set -g @everforest_bg_visual '#543a48'
  set -g @everforest_bg_red '#4c3743'
  set -g @everforest_bg_green '#445349'
  set -g @everforest_bg_blue '#3a515d'
  set -g @everforest_bg_yellow '#4d4c43'

  set -g @everforest_fg '#d3c6aa'
  set -g @everforest_red '#e67e80'
  set -g @everforest_orange '#e69875'
  set -g @everforest_yellow '#dbbc7f'
  set -g @everforest_green '#a7c080'
  set -g @everforest_aqua '#83c092'
  set -g @everforest_blue '#7fbbb3'
  set -g @everforest_purple '#d699b6'
  set -g @everforest_grey0 '#7a8478'
  set -g @everforest_grey1 '#859289'
  set -g @everforest_grey2 '#9da9a0'
  set -g @everforest_statusline1 '#a7c080'
  set -g @everforest_statusline2 '#d3c6aa'
  set -g @everforest_statusline3 '#e67e80'

  set -g @halfway_green '#5f7c61'

# === TRANSPARENT STATUS BAR CONFIG ===
# Replace your existing theme/formatting section with this

set-option -g status "on"
set -g status-interval 2

# Main status bar - transparent background
set-option -g status-style fg='#{@everforest_fg}',bg=default

# ---- Windows ----
# Default window title - transparent
set-window-option -g window-status-style fg='#{@everforest_grey1}',bg=default

# Window with activity alert
set-window-option -g window-status-activity-style fg='#{@everforest_orange}',bg=default

# Active window - transparent with bold highlight
set-window-option -g window-status-current-style fg='#{@everforest_green}',bg=default,bold

# ---- Pane ----
# pane borders
set-option -g pane-border-style fg='#475258'
set-option -g pane-active-border-style fg='#7fbbb3'

# ---- Command/Message ----
# message info - keeping a subtle background so you can read it
set-option -g message-style fg='#e67e80',bg='#1e2326'
set-option -g message-command-style fg='#d3c6aa',bg='#343f44'

# ---- Clock ----
set-window-option -g clock-mode-colour '#7fbbb3'

# ---- Bell ----
set-window-option -g window-status-bell-style fg='#e67e80',bg='#2d353b',bold

# ---- Formatting ----
set-option -g status-left-style none
set -g status-left-length 60
set -g status-left '#[fg=#{@everforest_green},bg=#{@everforest_bg0}]█'
set -ga status-left '#[fg=#{@everforest_green},bg=#{@everforest_bg0},reverse,bold] TMUX'
set -ga status-left '#[fg=#{@halfway_green},bg=#{@everforest_green}]'
set -ga status-left '#[fg=#{@everforest_bg2},bg=#{@halfway_green}]'
set -ga status-left '#[fg=#{@everforest_bg2},bg=#{@everforest_fg},bold] #S '
set -ga status-left '#[fg=#{@everforest_bg0},bg=#{@everforest_bg2}] '

set-option -g status-right-style none
set -g status-right-length 150
set -g status-right '#[fg=#{@everforest_grey1}]#(ss -lx | grep -c nvim) vim │ #(free | awk "/Mem:/{printf \"%.0f\", \$3/\$2*100}")%% mem │ #(awk "{printf \"%.0f\", \$1*100}" /proc/loadavg)%% cpu #[fg=#{@everforest_aqua},bold]│ #h '

set -g window-status-separator '#[fg=#{@everforest_grey2}] │ '
set -g window-status-format "#[fg=#{@everforest_grey1}]#I:#W#{?window_zoomed_flag, z,  }"
set -g window-status-current-format "#[fg=#{@everforest_green},bold]#I:#W#[fg=#{@everforest_aqua}]*#{?window_zoomed_flag,z, }"
# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
